<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ‘æ˜Ÿç™ºè¦‹ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #00ffff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            border-bottom: 2px solid #00ffff;
            padding-bottom: 20px;
        }
        
        .debug-panel {
            background: rgba(0, 50, 100, 0.3);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .flow-section {
            background: rgba(0, 30, 60, 0.5);
            border-left: 4px solid #00ff88;
            padding: 15px;
            margin: 15px 0;
        }
        
        h2 {
            color: #00ff88;
            margin-top: 0;
        }
        
        .step {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .step-number {
            display: inline-block;
            background: #00ffff;
            color: #000;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #0066cc, #00aaff);
            border: 2px solid #00ffff;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        .debug-output {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .status.success {
            background: #00aa00;
            color: white;
        }
        
        .status.error {
            background: #aa0000;
            color: white;
        }
        
        .status.warning {
            background: #aa6600;
            color: white;
        }
        
        .key-point {
            background: rgba(255, 100, 0, 0.2);
            border: 1px solid #ff6600;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .code-block {
            background: #1a1a1a;
            border: 1px solid #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #00ffff;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŸ æƒ‘æ˜Ÿç™ºè¦‹ã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒãƒƒã‚°ï¼†ãƒ•ãƒ­ãƒ¼ç¢ºèª</h1>
        
        <div class="debug-panel">
            <h2>ğŸ® ã‚²ãƒ¼ãƒ èµ·å‹•ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="launchGame()">ã‚²ãƒ¼ãƒ èµ·å‹•</button>
            <button onclick="checkSystems()">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</button>
            <button onclick="testDiscovery()">ç™ºè¦‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="game-status" class="debug-output"></div>
        </div>
        
        <div class="flow-section">
            <h2>ğŸ“‹ æƒ‘æ˜Ÿç™ºè¦‹ã®æ­£ã—ã„ãƒ•ãƒ­ãƒ¼</h2>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>ã‚²ãƒ¼ãƒ é–‹å§‹</strong>
                <ul>
                    <li>åœ°çƒã‚¨ãƒªã‚¢ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</li>
                    <li>PlanetDiscoverySystemãŒåˆæœŸåŒ–ã•ã‚Œã‚‹</li>
                    <li>ZoneManagerãŒå‹•çš„æƒ‘æ˜Ÿç”¨ã®Mapã‚’åˆæœŸåŒ–</li>
                </ul>
            </div>
            
            <div class="step">
                <span class="step-number">2</span>
                <strong>Xã‚­ãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</strong>
                <ul>
                    <li>ã‚¨ãƒãƒ«ã‚®ãƒ¼100æ¶ˆè²»</li>
                    <li>3ç§’é–“ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</li>
                    <li>ã‚¹ã‚­ãƒ£ãƒ³ç¯„å›²å†…ã®éš ã—æƒ‘æ˜Ÿã‚’æ¤œç´¢</li>
                </ul>
            </div>
            
            <div class="step">
                <span class="step-number">3</span>
                <strong>æƒ‘æ˜Ÿç™ºè¦‹æ™‚ã®å‡¦ç†</strong>
                <div class="code-block">
// PlanetDiscoverySystem.discoverPlanet()
1. foundPlanets.add(planetData.id) - ç™ºè¦‹æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
2. addPlanetToZone(planetData) - 3Dã‚·ãƒ¼ãƒ³ã«æƒ‘æ˜Ÿè¿½åŠ 
3. zoneManager.registerDiscoveredPlanet() - ZoneManagerã«ç™»éŒ²
4. warpSystem.discoverLocation() - ãƒ¯ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ ã«é€šçŸ¥
5. galaxyMap.discoverLocation() - ãƒãƒƒãƒ—ã«é€šçŸ¥
                </div>
            </div>
            
            <div class="step">
                <span class="step-number">4</span>
                <strong>ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆMã‚­ãƒ¼ï¼‰</strong>
                <ul>
                    <li>GalaxyMap.draw()ãŒå‘¼ã°ã‚Œã‚‹</li>
                    <li>zoneManager.getAllPlanetsForMap()ã§å…¨æƒ‘æ˜Ÿå–å¾—</li>
                    <li>é™çš„ã‚¾ãƒ¼ãƒ³ï¼‹å‹•çš„æƒ‘æ˜Ÿã‚’æç”»</li>
                    <li>æ–°ç™ºè¦‹æƒ‘æ˜Ÿã¯ãƒ”ãƒ³ã‚¯è‰²ï¼‹é‡‘æ ã§è¡¨ç¤º</li>
                </ul>
            </div>
        </div>
        
        <div class="key-point">
            <h3>âš ï¸ é‡è¦ãªç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h3>
            <ol>
                <li><strong>ZoneManager.discoveredPlanets</strong> - Mapã«æƒ‘æ˜ŸãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>GalaxyMap.getAllPlanetsForMap()</strong> - å‹•çš„æƒ‘æ˜ŸãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹</li>
                <li><strong>drawZone()</strong> - isDynamicãƒ•ãƒ©ã‚°ã§æ­£ã—ãæç”»ã•ã‚Œã¦ã„ã‚‹ã‹</li>
            </ol>
        </div>
        
        <div class="debug-panel">
            <h2>ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h2>
            <button onclick="checkPlanetRegistry()">æƒ‘æ˜Ÿãƒ¬ã‚¸ã‚¹ãƒˆãƒªç¢ºèª</button>
            <button onclick="checkMapData()">ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
            <button onclick="forceDiscovery()">å¼·åˆ¶ç™ºè¦‹ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearDebugLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="debug-console" class="debug-output"></div>
        </div>
        
        <div class="flow-section">
            <h2>ğŸ› æ—¢çŸ¥ã®å•é¡Œã¨è§£æ±ºç­–</h2>
            
            <div class="step">
                <strong>å•é¡Œ1: æ–°ç™ºè¦‹æƒ‘æ˜ŸãŒãƒãƒƒãƒ—ã«è¡¨ç¤ºã•ã‚Œãªã„</strong>
                <div class="key-point">
                    <p><strong>åŸå› å€™è£œ:</strong></p>
                    <ul>
                        <li>ZoneManagerã®registerDiscoveredPlanetãŒå‘¼ã°ã‚Œã¦ã„ãªã„</li>
                        <li>GalaxyMapãŒgetAllPlanetsForMapã‚’ä½¿ç”¨ã—ã¦ã„ãªã„</li>
                        <li>ãƒãƒƒãƒ—æç”»æ™‚ã«isDynamicãƒ•ãƒ©ã‚°ãŒèªè­˜ã•ã‚Œã¦ã„ãªã„</li>
                    </ul>
                </div>
            </div>
            
            <div class="step">
                <strong>å•é¡Œ2: ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚‚æƒ‘æ˜ŸãŒè¦‹ã¤ã‹ã‚‰ãªã„</strong>
                <div class="key-point">
                    <p><strong>ç¢ºèªäº‹é …:</strong></p>
                    <ul>
                        <li>ç¾åœ¨ã®ã‚¾ãƒ¼ãƒ³ã«ç™ºè¦‹å¯èƒ½ãªæƒ‘æ˜ŸãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹</li>
                        <li>ç™ºè¦‹ç¢ºç‡ãŒé©åˆ‡ã‹ï¼ˆåŸºæœ¬10% + ã‚¹ã‚­ãƒ£ãƒ³ãƒœãƒ¼ãƒŠã‚¹30%ï¼‰</li>
                        <li>æ—¢ã«ç™ºè¦‹æ¸ˆã¿ã§ã¯ãªã„ã‹</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="debug-panel">
            <h2>ğŸ¯ ã‚²ãƒ¼ãƒ åŸ‹ã‚è¾¼ã¿</h2>
            <iframe id="game-frame" src="http://localhost:3004/infinite-space-shooter-3d/" style="display:none;"></iframe>
            <button onclick="toggleGameFrame()">ã‚²ãƒ¼ãƒ è¡¨ç¤º/éè¡¨ç¤º</button>
            <p style="color: #ff6600; margin-top: 10px;">
                â€» ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ãŒ http://localhost:3004 ã§èµ·å‹•ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
            </p>
        </div>
    </div>
    
    <script>
        let gameWindow = null;
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(entry);
            
            const console = document.getElementById('debug-console');
            console.textContent = debugLog.slice(-20).join('\n');
            console.scrollTop = console.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('game-status');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            status.innerHTML = `<div class="status ${className}">${message}</div>`;
        }
        
        function launchGame() {
            log('ã‚²ãƒ¼ãƒ èµ·å‹•ä¸­...', 'info');
            const frame = document.getElementById('game-frame');
            frame.style.display = 'block';
            frame.src = 'http://localhost:3004/infinite-space-shooter-3d/';
            
            // ã‚²ãƒ¼ãƒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨­å®š
            frame.onload = () => {
                gameWindow = frame.contentWindow;
                log('ã‚²ãƒ¼ãƒ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ¥ç¶šå®Œäº†', 'success');
                updateStatus('ã‚²ãƒ¼ãƒ èµ·å‹•å®Œäº†', 'success');
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒƒã‚¯ã‚’è¨­å®š
                setupDebugHooks();
            };
        }
        
        function setupDebugHooks() {
            if (!gameWindow || !gameWindow.game) {
                log('ã‚²ãƒ¼ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const game = gameWindow.game;
            
            // æƒ‘æ˜Ÿç™ºè¦‹æ™‚ã®ãƒ•ãƒƒã‚¯ã‚’è¿½åŠ 
            if (game.planetDiscoverySystem) {
                const originalDiscover = game.planetDiscoverySystem.discoverPlanet;
                game.planetDiscoverySystem.discoverPlanet = function(planetData) {
                    log(`æƒ‘æ˜Ÿç™ºè¦‹: ${planetData.name} (ID: ${planetData.id})`, 'success');
                    originalDiscover.call(this, planetData);
                };
            }
            
            // ZoneManagerç™»éŒ²æ™‚ã®ãƒ•ãƒƒã‚¯
            if (game.zoneManager) {
                const originalRegister = game.zoneManager.registerDiscoveredPlanet;
                game.zoneManager.registerDiscoveredPlanet = function(planetData) {
                    log(`ZoneManagerç™»éŒ²: ${planetData.name}`, 'success');
                    originalRegister.call(this, planetData);
                };
            }
            
            log('ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒƒã‚¯è¨­å®šå®Œäº†', 'success');
        }
        
        function checkSystems() {
            if (!gameWindow || !gameWindow.game) {
                updateStatus('ã‚²ãƒ¼ãƒ ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const game = gameWindow.game;
            const systems = {
                'PlanetDiscoverySystem': !!game.planetDiscoverySystem,
                'ZoneManager': !!game.zoneManager,
                'GalaxyMap': !!game.galaxyMap,
                'WarpSystem': !!game.warpSystem,
                'discoveredPlanets Map': !!(game.zoneManager && game.zoneManager.discoveredPlanets)
            };
            
            log('=== ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ ===', 'info');
            for (const [name, status] of Object.entries(systems)) {
                log(`${name}: ${status ? 'âœ“ OK' : 'âœ— NG'}`, status ? 'success' : 'error');
            }
            
            if (game.zoneManager && game.zoneManager.discoveredPlanets) {
                log(`å‹•çš„æƒ‘æ˜Ÿæ•°: ${game.zoneManager.discoveredPlanets.size}`, 'info');
            }
        }
        
        function checkPlanetRegistry() {
            if (!gameWindow || !gameWindow.game || !gameWindow.game.zoneManager) {
                log('ZoneManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            const zm = gameWindow.game.zoneManager;
            log('=== æƒ‘æ˜Ÿãƒ¬ã‚¸ã‚¹ãƒˆãƒª ===', 'info');
            log(`é™çš„ã‚¾ãƒ¼ãƒ³æ•°: ${Object.keys(zm.zones).length}`, 'info');
            log(`å‹•çš„æƒ‘æ˜Ÿæ•°: ${zm.discoveredPlanets.size}`, 'info');
            
            if (zm.discoveredPlanets.size > 0) {
                log('å‹•çš„æƒ‘æ˜Ÿãƒªã‚¹ãƒˆ:', 'info');
                for (const [id, planet] of zm.discoveredPlanets) {
                    log(`- ${planet.name} (Zone: ${planet.zone})`, 'success');
                }
            }
        }
        
        function checkMapData() {
            if (!gameWindow || !gameWindow.game || !gameWindow.game.zoneManager) {
                log('ã‚²ãƒ¼ãƒ ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            const allPlanets = gameWindow.game.zoneManager.getAllPlanetsForMap();
            log('=== ãƒãƒƒãƒ—ç”¨æƒ‘æ˜Ÿãƒ‡ãƒ¼ã‚¿ ===', 'info');
            log(`ç·æƒ‘æ˜Ÿæ•°: ${Object.keys(allPlanets).length}`, 'info');
            
            for (const [id, planet] of Object.entries(allPlanets)) {
                const type = planet.isDynamic ? 'å‹•çš„' : 'é™çš„';
                log(`- ${planet.japaneseName || planet.name} [${type}]`, 'info');
            }
        }
        
        function testDiscovery() {
            if (!gameWindow || !gameWindow.game) {
                log('ã‚²ãƒ¼ãƒ ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            log('=== ç™ºè¦‹ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'info');
            
            // ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ
            if (gameWindow.game.planetDiscoverySystem) {
                log('ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­...', 'info');
                gameWindow.game.planetDiscoverySystem.startScan();
            } else {
                log('PlanetDiscoverySystemãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }
        
        function forceDiscovery() {
            if (!gameWindow || !gameWindow.game) {
                log('ã‚²ãƒ¼ãƒ ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const testPlanet = {
                id: 'test_planet_' + Date.now(),
                name: 'ãƒ†ã‚¹ãƒˆæƒ‘æ˜Ÿ-' + Math.floor(Math.random() * 999),
                type: 'ice_world',
                zone: gameWindow.game.zoneManager.currentZone,
                position: { x: 500, y: 0, z: 500 },
                radius: 20,
                color: 0xFF69B4,
                discoveryCondition: { type: 'scan' },
                rewards: {
                    credits: 1000,
                    items: ['test_item'],
                    experience: 100
                },
                lore: 'ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ†ã‚¹ãƒˆæƒ‘æ˜Ÿ'
            };
            
            log(`å¼·åˆ¶ç™ºè¦‹: ${testPlanet.name}`, 'warning');
            gameWindow.game.planetDiscoverySystem.discoverPlanet(testPlanet);
            
            // ãƒãƒƒãƒ—ã‚’é–‹ã„ã¦ç¢ºèª
            setTimeout(() => {
                if (gameWindow.game.galaxyMap && !gameWindow.game.galaxyMap.isOpen) {
                    log('ãƒãƒƒãƒ—ã‚’é–‹ã„ã¦ç¢ºèª...', 'info');
                    gameWindow.game.galaxyMap.open();
                }
            }, 1000);
        }
        
        function clearDebugLog() {
            debugLog = [];
            document.getElementById('debug-console').textContent = '';
            log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }
        
        function toggleGameFrame() {
            const frame = document.getElementById('game-frame');
            frame.style.display = frame.style.display === 'none' ? 'block' : 'none';
        }
        
        // åˆæœŸãƒ­ã‚°
        log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†', 'success');
        log('ã€Œã‚²ãƒ¼ãƒ èµ·å‹•ã€ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>