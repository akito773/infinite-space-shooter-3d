import { DialogueSystem } from './DialogueSystem.js';

export class LandingMenu {
    constructor(game) {
        this.game = game;
        this.isOpen = false;
        this.currentLocation = null;
        this.selectedIndex = 0;
        this.dialogueSystem = new DialogueSystem(game);
        
        this.createUI();
        this.setupEventListeners();
    }
    
    createUI() {
        // „É°„Éã„É•„Éº„Ç≥„É≥„ÉÜ„Éä
        this.menuContainer = document.createElement('div');
        this.menuContainer.id = 'landing-menu';
        this.menuContainer.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 20, 0.95);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 10px;
            padding: 20px;
            min-width: 400px;
            display: none;
            z-index: 2000;
            font-family: Arial, sans-serif;
        `;
        
        // „Çø„Ç§„Éà„É´
        this.titleElement = document.createElement('h2');
        this.titleElement.style.cssText = `
            color: #00ffff;
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        `;
        
        // Ë™¨ÊòéÊñá
        this.descriptionElement = document.createElement('p');
        this.descriptionElement.style.cssText = `
            color: #ffffff;
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 14px;
            line-height: 1.5;
        `;
        
        // „Ç™„Éó„Ç∑„Éß„É≥„É™„Çπ„Éà
        this.optionsContainer = document.createElement('div');
        this.optionsContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 10px;
        `;
        
        // Êìç‰ΩúË™¨Êòé
        this.controlsInfo = document.createElement('div');
        this.controlsInfo.style.cssText = `
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: #888888;
            text-align: center;
            font-size: 12px;
        `;
        this.controlsInfo.textContent = '‚Üë‚Üì: ÈÅ∏Êäû | Enter: Ê±∫ÂÆö | ESC: Èñâ„Åò„Çã';
        
        // Ë¶ÅÁ¥†„ÇíÁµÑ„ÅøÁ´ã„Å¶
        this.menuContainer.appendChild(this.titleElement);
        this.menuContainer.appendChild(this.descriptionElement);
        this.menuContainer.appendChild(this.optionsContainer);
        this.menuContainer.appendChild(this.controlsInfo);
        document.body.appendChild(this.menuContainer);
    }
    
    setupEventListeners() {
        document.addEventListener('keydown', (e) => {
            if (!this.isOpen) return;
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    this.selectPrevious();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    this.selectNext();
                    break;
                case 'Enter':
                    e.preventDefault();
                    this.confirmSelection();
                    break;
                case 'Escape':
                    e.preventDefault();
                    this.close();
                    break;
            }
        });
    }
    
    open(location) {
        this.currentLocation = location;
        this.selectedIndex = 0;
        this.isOpen = true;
        
        // „Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢
        this.game.isPaused = true;
        
        // „Çø„Ç§„Éà„É´„Å®Ë™¨Êòé„ÇíË®≠ÂÆö
        this.titleElement.textContent = location.name;
        this.descriptionElement.textContent = this.getLocationDescription(location);
        
        // „Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
        this.createOptions(location);
        
        // „É°„Éã„É•„Éº„ÇíË°®Á§∫
        this.menuContainer.style.display = 'block';
        
        // „Éï„Çß„Éº„Éâ„Ç§„É≥ÂäπÊûú
        this.menuContainer.style.opacity = '0';
        setTimeout(() => {
            this.menuContainer.style.transition = 'opacity 0.3s';
            this.menuContainer.style.opacity = '1';
        }, 10);
    }
    
    close() {
        this.isOpen = false;
        this.game.isPaused = false;
        
        // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
        this.menuContainer.style.opacity = '0';
        setTimeout(() => {
            this.menuContainer.style.display = 'none';
            this.menuContainer.style.transition = '';
        }, 300);
    }
    
    getLocationDescription(location) {
        const descriptions = {
            'spaceStation': 'ÂÆáÂÆô„ÅÆ‰∫§Â∑ÆÁÇπ„ÄÇÊßò„ÄÖ„Å™Á®ÆÊóè„ÅåÈõÜ„Åæ„Çã‰∫§Êòì„ÅÆ‰∏≠ÂøÉÂú∞„Åß„Åô„ÄÇ',
            'planet': 'Áæé„Åó„ÅÑÊ∞¥„ÅÆÊÉëÊòü„ÄÇ„Åó„Åã„Åó„ÄÅ„É¥„Ç©„Ç§„Éâ„ÅÆËÑÖÂ®Å„ÅåËø´„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            'colony': '‰∫∫È°û„ÅÆÊúÄÂâçÁ∑ö„ÄÇÂãáÊï¢„Å™ÈñãÊãìËÄÖ„Åü„Å°„ÅåÊöÆ„Çâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ'
        };
        
        return descriptions[location.type] || 'Êú™Áü•„ÅÆÂ†¥ÊâÄ„Åß„Åô„ÄÇ';
    }
    
    createOptions(location) {
        // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢
        this.optionsContainer.innerHTML = '';
        
        const options = this.getLocationOptions(location);
        this.optionElements = [];
        
        options.forEach((option, index) => {
            const optionElement = document.createElement('button');
            optionElement.style.cssText = `
                background: rgba(0, 50, 100, 0.5);
                border: 1px solid rgba(0, 150, 255, 0.5);
                color: white;
                padding: 15px 20px;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: left;
                position: relative;
                overflow: hidden;
            `;
            
            // „Ç¢„Ç§„Ç≥„É≥„Å®„ÉÜ„Ç≠„Çπ„Éà
            optionElement.innerHTML = `
                <span style="font-size: 20px; margin-right: 10px;">${option.icon}</span>
                <span>${option.text}</span>
                ${option.badge ? `<span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #ff6600; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${option.badge}</span>` : ''}
            `;
            
            optionElement.addEventListener('mouseenter', () => {
                this.selectedIndex = index;
                this.updateSelection();
            });
            
            optionElement.addEventListener('click', () => {
                this.confirmSelection();
            });
            
            this.optionsContainer.appendChild(optionElement);
            this.optionElements.push(optionElement);
        });
        
        this.options = options;
        this.updateSelection();
    }
    
    getLocationOptions(location) {
        const baseOptions = {
            spaceStation: [
                { text: '„Ç∑„Éß„ÉÉ„Éó„ÇíË¶ã„Çã', action: 'shop', icon: 'üõí' },
                { text: 'ÈÖíÂ†¥„ÅßÊÉÖÂ†±ÂèéÈõÜ', action: 'tavern', icon: 'üç∫' },
                { text: 'Ê©ü‰Ωì„Çí‰øÆÁêÜ', action: 'repair', icon: 'üîß' },
                { text: '„Éü„ÉÉ„Ç∑„Éß„É≥Á¢∫Ë™ç', action: 'missions', icon: 'üìã', badge: 'NEW' },
                { text: 'Âá∫Áô∫„Åô„Çã', action: 'leave', icon: 'üöÄ' }
            ],
            planet: [
                { text: 'Á∑èÁù£„Å®‰ºö„ÅÜ', action: 'governor', icon: 'üë§' },
                { text: 'Ë°ó„ÇíÊé¢Á¥¢', action: 'explore', icon: 'üèÉ' },
                { text: 'Á†îÁ©∂ÊâÄ„ÇíË®™Âïè', action: 'lab', icon: 'üî¨' },
                { text: 'ÊÉëÊòüÈñãÁô∫', action: 'develop', icon: 'üèóÔ∏è', badge: 'ÈñãÁô∫‰∏≠' },
                { text: '„ÇØ„Ç®„Çπ„ÉàÁ¢∫Ë™ç', action: 'quests', icon: '‚ùó', badge: '3' },
                { text: 'Âá∫Áô∫„Åô„Çã', action: 'leave', icon: 'üöÄ' }
            ],
            colony: [
                { text: 'ÈÅøÈõ£Ê∞ë„Å®Ë©±„Åô', action: 'refugees', icon: 'üë•' },
                { text: 'Èò≤Ë°õÊ∫ñÂÇô', action: 'defense', icon: 'üõ°Ô∏è' },
                { text: 'Áâ©Ë≥á„ÇíÂØÑ‰ªò', action: 'donate', icon: 'üì¶' },
                { text: 'Âá∫Áô∫„Åô„Çã', action: 'leave', icon: 'üöÄ' }
            ]
        };
        
        return baseOptions[location.type] || baseOptions.spaceStation;
    }
    
    selectPrevious() {
        this.selectedIndex = Math.max(0, this.selectedIndex - 1);
        this.updateSelection();
        if (this.game.soundManager) {
            this.game.soundManager.play('collect');
        }
    }
    
    selectNext() {
        this.selectedIndex = Math.min(this.options.length - 1, this.selectedIndex + 1);
        this.updateSelection();
        if (this.game.soundManager) {
            this.game.soundManager.play('collect');
        }
    }
    
    updateSelection() {
        this.optionElements.forEach((element, index) => {
            if (index === this.selectedIndex) {
                element.style.background = 'rgba(0, 100, 200, 0.8)';
                element.style.borderColor = 'rgba(0, 255, 255, 1)';
                element.style.transform = 'translateX(10px)';
                element.style.boxShadow = '0 0 20px rgba(0, 255, 255, 0.5)';
            } else {
                element.style.background = 'rgba(0, 50, 100, 0.5)';
                element.style.borderColor = 'rgba(0, 150, 255, 0.5)';
                element.style.transform = 'translateX(0)';
                element.style.boxShadow = 'none';
            }
        });
    }
    
    confirmSelection() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (this.game.soundManager) {
            this.game.soundManager.play('powerup');
        }
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÆüË°å
        this.handleAction(selectedOption.action);
    }
    
    handleAction(action) {
        switch(action) {
            case 'leave':
                this.close();
                this.showMessage('Èõ¢Èô∏„Åó„Åæ„Åó„ÅüÔºÅ');
                break;
                
            case 'shop':
                this.close();
                if (this.game.shopSystem) {
                    this.game.shopSystem.open(true);  // ÁùÄÈô∏„É°„Éã„É•„Éº„Åã„ÇâÈñã„ÅÑ„Åü„Åì„Å®„Çí‰ºù„Åà„Çã
                }
                break;
                
            case 'tavern':
                this.close();
                // „É´„Éä„Å®„Åæ„Å†Âá∫‰ºö„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂá∫‰ºö„ÅÑ„Ç§„Éô„É≥„Éà
                if (this.game.storySystem && !this.game.storySystem.storyFlags.hasMetLuna) {
                    // „É´„Éä„Å®„ÅÆÂá∫‰ºö„ÅÑ„Ç§„Éô„É≥„Éà„Çí„Éà„É™„Ç¨„Éº
                    if (this.game.storyEventTrigger) {
                        this.game.storyEventTrigger.forceEvent('earth_first_landing');
                    } else if (this.game.triggerTavernMeeting) {
                        this.game.triggerTavernMeeting();
                    }
                } else {
                    // „Åô„Åß„Å´Âá∫‰ºö„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÈÖíÂ†¥‰ºöË©±
                    this.dialogueSystem.startDialogue('merchant', 'first', 'ÈÖíÂ†¥');
                }
                break;
                
            case 'lab':
                this.close();
                this.dialogueSystem.startDialogue('scientist');
                break;
                
            case 'refugees':
                this.close();
                this.dialogueSystem.startDialogue('refugee');
                break;
                
            case 'repair':
                if (this.game.player.health < this.game.player.maxHealth) {
                    this.game.player.health = this.game.player.maxHealth;
                    this.game.updateHealth(this.game.player.health, this.game.player.maxHealth);
                    this.showMessage('Ê©ü‰Ωì„ÇíÂÆåÂÖ®„Å´‰øÆÁêÜ„Åó„Åæ„Åó„ÅüÔºÅ');
                } else {
                    this.showMessage('Ê©ü‰Ωì„ÅØÊó¢„Å´‰∏áÂÖ®„ÅÆÁä∂ÊÖã„Åß„Åô„ÄÇ');
                }
                break;
                
            case 'governor':
                this.close();
                this.dialogueSystem.startDialogue('governor');
                break;
                
            case 'explore':
                this.showMessage('Ë°ó„ÅÆÊé¢Á¥¢Ê©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô...');
                break;
                
            case 'missions':
                this.showMessage('„Éü„ÉÉ„Ç∑„Éß„É≥Ê©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
                break;
                
            case 'quests':
                this.showMessage('„ÇØ„Ç®„Çπ„ÉàÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
                break;
                
            case 'defense':
                this.showMessage('Èò≤Ë°õÊ∫ñÂÇôÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
                break;
                
            case 'donate':
                this.showMessage('ÂØÑ‰ªòÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
                break;
                
            case 'develop':
                this.close();
                this.showDevelopmentPreview();
                break;
                
            default:
                this.showMessage(`${action}Ê©üËÉΩ„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô...`);
        }
    }
    
    showMessage(text) {
        const message = document.createElement('div');
        message.style.cssText = `
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 3000;
            animation: messageSlide 2s ease-out;
        `;
        message.textContent = text;
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
        if (!document.querySelector('#message-animation-style')) {
            const style = document.createElement('style');
            style.id = 'message-animation-style';
            style.textContent = `
                @keyframes messageSlide {
                    0% {
                        opacity: 0;
                        transform: translateX(-50%) translateY(20px);
                    }
                    20% {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                    80% {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                    100% {
                        opacity: 0;
                        transform: translateX(-50%) translateY(-20px);
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.remove();
        }, 2000);
    }
    
    showDevelopmentPreview() {
        // ÊÉëÊòüÈñãÁô∫„Éó„É¨„Éì„É•„ÉºÁîªÈù¢
        const preview = document.createElement('div');
        preview.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: linear-gradient(135deg, rgba(0, 20, 40, 0.98), rgba(0, 40, 80, 0.98));
            border: 2px solid rgba(0, 200, 255, 0.8);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 200, 255, 0.5);
        `;
        
        content.innerHTML = `
            <h1 style="color: #00ffff; margin-bottom: 30px; font-size: 32px;">
                üèóÔ∏è ÊÉëÊòüÈñãÁô∫„Ç∑„Çπ„ÉÜ„É†
            </h1>
            <div style="color: white; font-size: 18px; line-height: 1.8; margin-bottom: 30px;">
                <p>„Åì„ÅÆÊ©üËÉΩ„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„Åß„ÅôÔºÅ</p>
                <p style="color: #ffaa00; margin: 20px 0;">
                    Coming Soon...
                </p>
                <div style="text-align: left; background: rgba(0, 0, 0, 0.5); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #00ff00; margin-bottom: 15px;">ÂÆüË£Ö‰∫àÂÆö„ÅÆÊ©üËÉΩ:</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li>üè≠ Âü∫Âú∞Âª∫Ë®≠ - ÊñΩË®≠„ÇíÂª∫„Å¶„Å¶Ë≥áÊ∫ê„ÇíËá™ÂãïÁîüÁî£</li>
                        <li>‚õèÔ∏è Êé°Êéò„Ç∑„Çπ„ÉÜ„É† - ÊÉëÊòü„ÅÆË≥áÊ∫ê„ÇíÊé°Êéò</li>
                        <li>üî¨ Á†îÁ©∂ÈñãÁô∫ - Êñ∞ÊäÄË°ì„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØ</li>
                        <li>üõ°Ô∏è Èò≤Ë°õË®≠ÂÇô - Âü∫Âú∞„ÇíÂÆà„ÇãËá™ÂãïÈò≤Ë°õ„Ç∑„Çπ„ÉÜ„É†</li>
                        <li>üöá Âú∞‰∏ãÊé¢Á¥¢ - 2.5D„É¢„Éº„Éâ„ÅßÂú∞‰∏ã„ÇíÊé¢Ê§ú</li>
                        <li>üíé „É¨„Ç¢Ë≥áÊ∫ê - Ê∑±Â±§„ÅßÂ∏åÂ∞ë„Å™Ë≥áÊ∫ê„ÇíÁô∫Ë¶ã</li>
                    </ul>
                </div>
                <p style="font-size: 14px; color: #888;">
                    ‚Äª Âà•„Ç∑„Çπ„ÉÜ„É†„Å®„Åó„Å¶ÈñãÁô∫‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅÁµ±Âêà„Åæ„Åß„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ
                </p>
            </div>
            <button id="close-preview" style="
                padding: 15px 40px;
                font-size: 18px;
                background: linear-gradient(45deg, rgba(0, 100, 200, 0.8), rgba(0, 200, 255, 0.8));
                border: 2px solid white;
                color: white;
                cursor: pointer;
                border-radius: 30px;
                transition: all 0.3s;
            ">Èñâ„Åò„Çã</button>
        `;
        
        preview.appendChild(content);
        document.body.appendChild(preview);
        
        // „Éï„Çß„Éº„Éâ„Ç§„É≥
        preview.style.opacity = '0';
        setTimeout(() => {
            preview.style.transition = 'opacity 0.3s';
            preview.style.opacity = '1';
        }, 10);
        
        // Èñâ„Åò„Çã„Éú„Çø„É≥
        document.getElementById('close-preview').addEventListener('click', () => {
            preview.style.opacity = '0';
            setTimeout(() => {
                preview.remove();
                // ÁùÄÈô∏„É°„Éã„É•„Éº„ÇíÂÜçÂ∫¶Èñã„Åè
                this.open(this.currentLocation);
            }, 300);
        });
        
        // ESC„Ç≠„Éº„Åß„ÇÇÈñâ„Åò„Çã
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                document.getElementById('close-preview').click();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
    }
}