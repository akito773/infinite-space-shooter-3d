// Ëº∏ÈÄÅUI - Ëº∏ÈÄÅÂ•ëÁ¥Ñ„ÅÆÁÆ°ÁêÜ„Å®Ëº∏ÈÄÅÁä∂Ê≥Å„ÅÆË°®Á§∫

export class TransportUI {
    constructor(game) {
        this.game = game;
        this.isVisible = false;
        this.selectedShipType = 'small';
        this.selectedCargo = {
            iron: 0,
            energy: 0,
            crystal: 0
        };
        
        this.createUI();
        this.setupEventListeners();
    }
    
    createUI() {
        // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä
        this.container = document.createElement('div');
        this.container.id = 'transport-ui';
        this.container.className = 'ui-panel';
        this.container.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            min-width: 500px;
            max-width: 800px;
            color: #ffffff;
            font-family: 'Orbitron', monospace;
            display: none;
            z-index: 1000;
        `;
        
        // „Éò„ÉÉ„ÉÄ„Éº
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ffff;
        `;
        
        const title = document.createElement('h2');
        title.textContent = 'üöÄ Ëº∏ÈÄÅ„Çø„Éº„Éü„Éä„É´';
        title.style.cssText = `
            margin: 0;
            color: #00ffff;
            font-size: 24px;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úï';
        closeBtn.style.cssText = `
            background: none;
            border: none;
            color: #ff4444;
            font-size: 20px;
            cursor: pointer;
        `;
        closeBtn.onclick = () => this.hide();
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢
        this.contentArea = document.createElement('div');
        this.contentArea.style.cssText = `
            display: flex;
            gap: 20px;
        `;
        
        // Â∑¶ÂÅ¥ÔºöÊñ∞Ë¶èÂ•ëÁ¥Ñ
        const leftPanel = document.createElement('div');
        leftPanel.style.cssText = `
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
        `;
        
        const contractTitle = document.createElement('h3');
        contractTitle.textContent = 'Êñ∞Ë¶èËº∏ÈÄÅÂ•ëÁ¥Ñ';
        contractTitle.style.cssText = `
            margin: 0 0 15px 0;
            color: #44ff44;
            font-size: 18px;
        `;
        leftPanel.appendChild(contractTitle);
        
        // Ëº∏ÈÄÅËàπ„Çø„Ç§„ÉóÈÅ∏Êäû
        const shipTypeSection = this.createShipTypeSelector();
        leftPanel.appendChild(shipTypeSection);
        
        // Ë≤®Áâ©ÈÅ∏Êäû
        const cargoSection = this.createCargoSelector();
        leftPanel.appendChild(cargoSection);
        
        // Â•ëÁ¥Ñ„Éú„Çø„É≥
        this.contractButton = document.createElement('button');
        this.contractButton.textContent = 'Ëº∏ÈÄÅÂ•ëÁ¥Ñ„Çí‰ΩúÊàê';
        this.contractButton.style.cssText = `
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            background: #44ff44;
            border: none;
            border-radius: 5px;
            color: #000000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        `;
        this.contractButton.onmouseover = () => {
            this.contractButton.style.background = '#66ff66';
        };
        this.contractButton.onmouseout = () => {
            this.contractButton.style.background = '#44ff44';
        };
        this.contractButton.onclick = () => this.createContract();
        leftPanel.appendChild(this.contractButton);
        
        // Âè≥ÂÅ¥ÔºöÁèæÂú®„ÅÆËº∏ÈÄÅÁä∂Ê≥Å
        const rightPanel = document.createElement('div');
        rightPanel.style.cssText = `
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
        `;
        
        const statusTitle = document.createElement('h3');
        statusTitle.textContent = 'Ëº∏ÈÄÅÁä∂Ê≥Å';
        statusTitle.style.cssText = `
            margin: 0 0 15px 0;
            color: #44ff44;
            font-size: 18px;
        `;
        rightPanel.appendChild(statusTitle);
        
        this.statusContainer = document.createElement('div');
        this.statusContainer.style.cssText = `
            max-height: 300px;
            overflow-y: auto;
        `;
        rightPanel.appendChild(this.statusContainer);
        
        // „Éë„Éç„É´„ÇíËøΩÂä†
        this.contentArea.appendChild(leftPanel);
        this.contentArea.appendChild(rightPanel);
        
        // „Çø„Éº„Éü„Éä„É´ÊÉÖÂ†±
        this.terminalInfo = document.createElement('div');
        this.terminalInfo.style.cssText = `
            margin-top: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            font-size: 14px;
        `;
        
        // ÁµÑ„ÅøÁ´ã„Å¶
        this.container.appendChild(header);
        this.container.appendChild(this.contentArea);
        this.container.appendChild(this.terminalInfo);
        
        document.body.appendChild(this.container);
    }
    
    createShipTypeSelector() {
        const container = document.createElement('div');
        container.style.cssText = `
            margin-bottom: 15px;
        `;
        
        const label = document.createElement('div');
        label.textContent = 'Ëº∏ÈÄÅËàπ„Çø„Ç§„Éó:';
        label.style.cssText = `
            margin-bottom: 5px;
            color: #aaaaaa;
        `;
        container.appendChild(label);
        
        const shipTypes = this.game.systems.transport.shipTypes;
        
        Object.entries(shipTypes).forEach(([type, data]) => {
            const option = document.createElement('div');
            option.style.cssText = `
                padding: 10px;
                margin: 5px 0;
                background: rgba(255, 255, 255, 0.1);
                border: 2px solid ${this.selectedShipType === type ? '#00ffff' : 'transparent'};
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s;
            `;
            
            option.innerHTML = `
                <div style="font-weight: bold; color: #00ffff;">${data.name}</div>
                <div style="font-size: 12px; color: #aaaaaa;">
                    ÂÆπÈáè: ${data.capacity} | ÈÄüÂ∫¶: ${data.speed} | „Ç≥„Çπ„Éà: ${data.cost}
                </div>
            `;
            
            option.onclick = () => {
                this.selectedShipType = type;
                this.updateUI();
            };
            
            option.onmouseover = () => {
                if (this.selectedShipType !== type) {
                    option.style.border = '2px solid rgba(0, 255, 255, 0.5)';
                }
            };
            
            option.onmouseout = () => {
                if (this.selectedShipType !== type) {
                    option.style.border = '2px solid transparent';
                }
            };
            
            container.appendChild(option);
        });
        
        return container;
    }
    
    createCargoSelector() {
        const container = document.createElement('div');
        container.style.cssText = `
            margin-bottom: 15px;
        `;
        
        const label = document.createElement('div');
        label.textContent = 'Ë≤®Áâ©ÂÜÖÂÆπ:';
        label.style.cssText = `
            margin-bottom: 5px;
            color: #aaaaaa;
        `;
        container.appendChild(label);
        
        const resources = ['iron', 'energy', 'crystal'];
        const maxCapacity = this.game.systems.transport.shipTypes[this.selectedShipType].capacity;
        
        resources.forEach(resource => {
            const resourceContainer = document.createElement('div');
            resourceContainer.style.cssText = `
                display: flex;
                align-items: center;
                margin: 10px 0;
            `;
            
            const resourceLabel = document.createElement('span');
            resourceLabel.textContent = resource.charAt(0).toUpperCase() + resource.slice(1) + ':';
            resourceLabel.style.cssText = `
                width: 80px;
                color: #ffffff;
            `;
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.min = 0;
            slider.max = maxCapacity;
            slider.value = this.selectedCargo[resource];
            slider.style.cssText = `
                flex: 1;
                margin: 0 10px;
            `;
            
            const valueDisplay = document.createElement('span');
            valueDisplay.textContent = this.selectedCargo[resource];
            valueDisplay.style.cssText = `
                width: 60px;
                text-align: right;
                color: #44ff44;
            `;
            
            slider.oninput = () => {
                const total = Object.values(this.selectedCargo).reduce((sum, val) => sum + val, 0) 
                            - this.selectedCargo[resource] + parseInt(slider.value);
                
                if (total <= maxCapacity) {
                    this.selectedCargo[resource] = parseInt(slider.value);
                    valueDisplay.textContent = slider.value;
                } else {
                    slider.value = this.selectedCargo[resource];
                }
                
                this.updateCargoDisplay();
            };
            
            resourceContainer.appendChild(resourceLabel);
            resourceContainer.appendChild(slider);
            resourceContainer.appendChild(valueDisplay);
            container.appendChild(resourceContainer);
        });
        
        // ÂÆπÈáèË°®Á§∫
        this.capacityDisplay = document.createElement('div');
        this.capacityDisplay.style.cssText = `
            margin-top: 10px;
            text-align: center;
            color: #ffff44;
        `;
        container.appendChild(this.capacityDisplay);
        
        this.updateCargoDisplay();
        
        return container;
    }
    
    updateCargoDisplay() {
        const total = Object.values(this.selectedCargo).reduce((sum, val) => sum + val, 0);
        const maxCapacity = this.game.systems.transport.shipTypes[this.selectedShipType].capacity;
        this.capacityDisplay.textContent = `ÂÆπÈáè: ${total} / ${maxCapacity}`;
        
        if (total > maxCapacity) {
            this.capacityDisplay.style.color = '#ff4444';
        } else if (total === maxCapacity) {
            this.capacityDisplay.style.color = '#44ff44';
        } else {
            this.capacityDisplay.style.color = '#ffff44';
        }
    }
    
    createContract() {
        const transport = this.game.systems.transport;
        
        // „Çø„Éº„Éü„Éä„É´„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (!transport.hasAvailableTerminal()) {
            this.game.showMessage('Âà©Áî®ÂèØËÉΩ„Å™Ëº∏ÈÄÅ„Çø„Éº„Éü„Éä„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
            return;
        }
        
        // Ë≤®Áâ©„ÅåÁ©∫„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const total = Object.values(this.selectedCargo).reduce((sum, val) => sum + val, 0);
        if (total === 0) {
            this.game.showMessage('Ë≤®Áâ©„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
            return;
        }
        
        // „Ç≥„Çπ„ÉàË®àÁÆó
        const cost = transport.calculateTransportCost({
            from: 'current_planet',
            to: 'earth',
            cargo: this.selectedCargo,
            shipType: this.selectedShipType
        });
        
        // Ë≥áÊ∫ê„ÉÅ„Çß„ÉÉ„ÇØ
        const resources = this.game.systems.resource.getResources();
        if (resources.credits < cost) {
            this.game.showMessage(`„ÇØ„É¨„Ç∏„ÉÉ„Éà„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô (ÂøÖË¶Å: ${cost})`, 'error');
            return;
        }
        
        // Â•ëÁ¥Ñ‰ΩúÊàê
        const contract = transport.createContract({
            from: 'current_planet',
            to: 'earth',
            cargo: { ...this.selectedCargo },
            shipType: this.selectedShipType,
            type: 'regular'
        });
        
        // „Ç≥„Çπ„Éà„ÇíÊîØÊâï„ÅÜ
        this.game.systems.resource.consumeResource('credits', cost);
        
        this.game.showMessage('Ëº∏ÈÄÅÂ•ëÁ¥Ñ„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
        this.updateUI();
        
        // Ë≤®Áâ©„Çí„É™„Çª„ÉÉ„Éà
        this.selectedCargo = { iron: 0, energy: 0, crystal: 0 };
    }
    
    updateUI() {
        // Ëº∏ÈÄÅÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
        this.updateTransportStatus();
        
        // „Çø„Éº„Éü„Éä„É´ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        this.updateTerminalInfo();
        
        // UI„ÇíÂÜçÊèèÁîªÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÅÆÊõ¥Êñ∞„Å™„Å©Ôºâ
        const shipOptions = this.container.querySelectorAll('.ship-option');
        shipOptions.forEach(option => {
            // ÂÆüË£Ö„ÅåÂøÖË¶Å„Å™Â†¥Âêà
        });
    }
    
    updateTransportStatus() {
        const data = this.game.systems.transport.getTransportData();
        
        this.statusContainer.innerHTML = '';
        
        if (data.schedule.length === 0) {
            this.statusContainer.innerHTML = '<div style="color: #aaaaaa;">Ëº∏ÈÄÅ‰∏≠„ÅÆËàπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            return;
        }
        
        data.schedule.forEach(scheduled => {
            const contract = data.contracts.find(c => c.id === scheduled.contractId);
            if (!contract) return;
            
            const statusItem = document.createElement('div');
            statusItem.style.cssText = `
                padding: 10px;
                margin: 5px 0;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 5px;
            `;
            
            const shipInfo = this.game.systems.transport.shipTypes[contract.shipType];
            const timeRemaining = Math.max(0, scheduled.arrivalTime - Date.now()) / 1000;
            
            statusItem.innerHTML = `
                <div style="font-weight: bold; color: #44ff44;">
                    ${shipInfo.name} - ${scheduled.status === 'in_transit' ? 'Ëº∏ÈÄÅ‰∏≠' : '„Çπ„Ç±„Ç∏„É•„Éº„É´Ê∏à„Åø'}
                </div>
                <div style="font-size: 12px; color: #aaaaaa;">
                    Ë≤®Áâ©: ${this.formatCargo(contract.cargo)}
                </div>
                <div style="font-size: 12px; color: #ffff44;">
                    Âà∞ÁùÄ„Åæ„Åß: ${Math.floor(timeRemaining)}Áßí
                </div>
            `;
            
            this.statusContainer.appendChild(statusItem);
        });
    }
    
    updateTerminalInfo() {
        const data = this.game.systems.transport.getTransportData();
        
        let terminalCount = data.terminals.length;
        let totalCapacity = 0;
        let usedCapacity = 0;
        
        data.terminals.forEach(terminal => {
            totalCapacity += terminal.capacity;
            usedCapacity += terminal.currentShips;
        });
        
        this.terminalInfo.innerHTML = `
            <div style="color: #00ffff;">„Çø„Éº„Éü„Éä„É´ÊÉÖÂ†±</div>
            <div style="margin-top: 5px;">
                „Çø„Éº„Éü„Éä„É´Êï∞: ${terminalCount} | 
                ÁùÄÈô∏ÂÆπÈáè: ${usedCapacity}/${totalCapacity} | 
                Ëº∏ÈÄÅ‰∏≠: ${data.schedule.length}
            </div>
        `;
    }
    
    formatCargo(cargo) {
        const parts = [];
        Object.entries(cargo).forEach(([resource, amount]) => {
            if (amount > 0) {
                parts.push(`${resource}: ${amount}`);
            }
        });
        return parts.join(', ');
    }
    
    setupEventListeners() {
        // Y„Ç≠„Éº„Åß„Éà„Ç∞„É´ÔºàT„ÅØ„Åô„Åß„Å´Debug„Åß‰ΩøÁî®‰∏≠„ÅÆ„Åü„ÇÅÔºâ
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'y' && !e.ctrlKey && !e.altKey) {
                if (this.isVisible) {
                    this.hide();
                } else {
                    this.show();
                }
            }
        });
    }
    
    show() {
        if (!this.game.systems.transport.hasAvailableTerminal()) {
            this.game.showMessage('Ëº∏ÈÄÅ„Çø„Éº„Éü„Éä„É´„ÇíÂª∫Ë®≠„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
            return;
        }
        
        this.isVisible = true;
        this.container.style.display = 'block';
        this.updateUI();
        
        // ÂÆöÊúüÊõ¥Êñ∞
        this.updateInterval = setInterval(() => {
            this.updateUI();
        }, 1000);
    }
    
    hide() {
        this.isVisible = false;
        this.container.style.display = 'none';
        
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }
}